<button class="close" mat-button (click)="onClose()">&times;</button>
<div mat-dialog-content>
<mat-stepper [linear]="isLinear" id="stepper" #stepper>
    <mat-step completed="false">
      <div class="stepper-content">
        <ng-template matStepLabel>Auswahl einer Gruppe{{'' | translate}}</ng-template>
        <ng-container>
          Bitte wähle sie eine Gruppe aus:
        </ng-container>
        <ng-container *ngIf="data.patient.associatedIdGroups.length <= 4">
          <mat-radio-group
            style="padding-top: 20px;"
            class="groups-radio-group"
            [(ngModel)]="dataModel"
            #radioGroup>
            <mat-radio-button class="groups-radio-button" *ngFor="let group of data.patient.associatedIdGroups" [value]="group">
              {{group.name}}
            </mat-radio-button>
          </mat-radio-group>
        </ng-container>
        <ng-container *ngIf="data.patient.associatedIdGroups.length > 4">
          <mat-form-field appearance="fill">
            <mat-select (selectionChange)="dataModel = $event.value">
              <mat-option *ngFor="let group of data.patient.associatedIdGroups" [value]="group">
                {{group.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </ng-container>
      </div>
      <div class="stepper-action">
        <div class="left-section"></div>
        <div class="right-section">
        <button
          mat-raised-button
          class="submit"
          id="actionButton"
          [disabled]="dataModel == undefined"
          (click)="stepper.reset(); setupTable(); toSecondStep(); stepper.selected!.completed = true; this.stepper.next();">
          Weiter{{'' | translate}}
        </button>
        </div>

      </div>
    </mat-step>
    <mat-step completed="false">
      <div class="stepper-content">
        <ng-template matStepLabel>Gruppen Ids{{'' | translate}}</ng-template>
        <associated-ids-table *ngIf="step == 1" [data]="tableData">
        </associated-ids-table>
      </div>
      <div class="stepper-action">
        <div class="left-section">
            <button
              mat-raised-button
              id="backButton"
              (click)="step = 0; this.stepper.previous(); stepper.selected!.completed = false;"
            >
            Zurück {{'' | translate}}
            </button>
        </div>
        <div class="right-section">
            <button
              mat-raised-button
              class="submit"
              id="newEntry"
              (click)="step = 2; generate(); stepper.selected!.completed = true; this.stepper.next();"
            >
              Neuer Eintrag{{'' | translate}}
            </button>
        </div>
      </div>
    </mat-step>
    <mat-step completed="false">
      <div>
        <ng-template matStepLabel>Eintrag bearbeiten{{'' | translate}}</ng-template>
        <ng-container *ngIf="canGenerate">
          <div class="stepper-content">
            <form #intIdsForm="ngForm" style="margin-left: 5%;">
            <div ngModelGroup="internalIds"
         #internalIdModelGroup="ngModelGroup">
              <h4>Wählen sie einen internen Id-Typen aus:{{'' | translate}}</h4>
              <mat-form-field color="primary" style="width: 76.5%">
                <mat-label>{{'' | translate}}</mat-label>
                <mat-chip-list #chipList aria-label="Fruit selection"
                               name="internalIdTypesChipList"
                               [ngModel]="selectedInternalIds">
                  <mat-chip *ngFor="let id of selectedInternalIds"
                            [selectable]="true"
                            [removable]="true"
                            (removed)="removeInternalId(id)">
                    {{id.name}}
                    <button matChipRemove>
                      <mat-icon>cancel</mat-icon>
                    </button>
                  </mat-chip>
                  <input [formControl]="chipListInputCtrl"
                         [matChipInputFor]="chipList"
                         [matAutocomplete]="auto"
                         [matChipInputAddOnBlur]="true"
                         (matChipInputTokenEnd)="findAndAddInternalId($event)">
                </mat-chip-list>
                <mat-autocomplete #auto="matAutocomplete"
                                  (optionSelected)="selectedInternalId($event)">
                  <mat-option style="height: auto" *ngFor="let id of this.filteredInternalIds | async"
                              [value]="id.id.id">
                    <div [hidden]="id.added">{{id.id.name}}</div>
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>
            </div>
          
              <!-- vorherige Implementation mit einem DropDownSelect
              <div>
                Wählen sie einen internen Id-Typen aus:
              </div>
              <mat-form-field appearance="fill">
                <mat-label>IntId{{'' | translate}}</mat-label>
                <mat-select [required]="true" (selectionChange)="idType[0] = $event;">
                  <mat-option *ngFor="let id of internalIds" [value]="id.id">
                    {{id.name}}
                  </mat-option>
                </mat-select>
                <mat-error>Error</mat-error>
              </mat-form-field>
            </div>-->

            <div>
              <h4>Wählen sie einen externen Id-Typen aus und tragen sie die Id ein: (optional)</h4>
              <mat-form-field appearance="fill">
                <mat-label>ExtId{{'' | translate}}</mat-label>
                <mat-select (selectionChange)="idType = $event; input.value = ''; idString = ''" #option>
                  <mat-option *ngFor="let id of externalIds" [value]="id.id">
                    {{id.name}}
                  </mat-option>
                </mat-select>
              </mat-form-field>
          
              <mat-form-field appearance="fill" id="idInput">
                <mat-label>{{'' | translate}}</mat-label>
                <input matInput [disabled]="idType == null || option.value === '-'" [required]="idType != null && option.value !== '-'" (keyup)="idString = input.value" #input>
              </mat-form-field>
            </div>
          </form>
          </div>
        
          <div class="stepper-action">
            <div class="left-section">
              <button mat-raised-button id="backButton" (click)="removeAllChips(); toSecondStep(); this.stepper.previous(); stepper.selected!.completed = false;">
                Zurück{{'' | translate}}
              </button>
            </div>
            <div class="right-section">
              <button
                mat-raised-button
                class="submit"
                id="actionButton"
                [disabled]="selectedInternalIds.length == 0 || (idType != null && option.value !== '-' && idString === '')"
                (click)="addId(); step = 3; stepper.selected!.completed = true; this.stepper.next();"
              >
                {{'button_save_new_id' | translate}}
              </button>
            </div>
          </div>
        </ng-container>
        
        <ng-container *ngIf="!canGenerate">
          <div class="stepper-content">
            ERROR: please select a valid group
          </div>
          <div class="stepper-action">
            <div class="left-section">
              <button mat-raised-button id="backButton" (click)="toSecondStep(); this.stepper.previous(); stepper.selected!.completed = false;">
                Zurück{{'' | translate}}
              </button>
            </div>
            <div class="right-section">
            </div>
          </div>
        </ng-container>
      </div>
    </mat-step>
    <mat-step completed="false">
      <ng-template matStepLabel>Erstellte Id{{''|translate}}</ng-template>
      <div class="stepper-content">
        <ng-container *ngIf="generatedId != undefined">
          <div *ngFor="let id of generatedId.idTypes" #buttonContainer>
            {{id.idType}}: {{id.idString}}
            <button mat-icon-button [cdkCopyToClipboard]="id.idString" [matTooltip]="'copy Id{translate}'">
              <mat-icon id="copyIcon" [ngStyle]="{'color':'#888888', 'transform':'scale(0.8)'}">file_copy</mat-icon>
            </button>
          </div>
        </ng-container>
        <ng-container *ngIf="generatedId == undefined">
          error
        </ng-container>
      </div>
      <div class="stepper-action">
        <div class="left-section">
        </div>
        <div class="right-section">
            <button
              mat-raised-button
              class="submit"
              id="actionButton"
              (click)="onClose()"
            >
              Schließen{{'' | translate}}
            </button>
        </div>
      </div>
    </mat-step>
  </mat-stepper>
</div>